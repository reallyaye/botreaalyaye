{% extends "base.html" %}
{% block title %}NOVIII Fitness - Тренировки{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="/static/workouts.css?v=1.0.2">
{% endblock %}
{% block content %}
<div class="section card fade-in">
  <h1 class="section-title">Тренировки</h1>
  <p class="hero-text">Ваши завершённые тренировки и прогресс</p>

  <div class="section">
    <h2 class="section-title"><i class="fas fa-compass" style="color: var(--primary); margin-right: 10px;"></i>Виды тренировок</h2>
    <div class="workout-grid">
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--tertiary-light); color: var(--tertiary);">
            <i class="fas fa-running"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Кардио</h3>
          <p class="workout-description">Улучшите выносливость и сожгите калории.</p>
        </div>
      </div>
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--primary-light); color: var(--primary);">
            <i class="fas fa-dumbbell"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Силовые</h3>
          <p class="workout-description">Нарастите мышечную массу и увеличьте силу.</p>
        </div>
      </div>
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--success-light); color: var(--success);">
            <i class="fas fa-spa"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Йога</h3>
          <p class="workout-description">Повысьте гибкость и внутреннюю гармонию.</p>
        </div>
      </div>
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--warning-light); color: var(--warning);">
            <i class="fas fa-child"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Растяжка</h3>
          <p class="workout-description">Улучшите подвижность и снимите напряжение.</p>
        </div>
      </div>
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--danger-light); color: var(--danger);">
            <i class="fas fa-fire"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Высокоинтенсивные (ВИИТ)</h3>
          <p class="workout-description">Максимальная эффективность за короткое время.</p>
        </div>
      </div>
      <div class="workout-card">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--info-light); color: var(--info);">
            <i class="fas fa-person-walking"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Функциональные</h3>
          <p class="workout-description">Укрепите тело для повседневной жизни.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title"><i class="fas fa-book-open" style="color: var(--primary); margin-right: 10px;"></i>Библиотека тренировок</h2>
    <div class="workout-grid">
      <div class="workout-card" data-activity="Утренняя зарядка" data-intensity="Обычная" data-duration="15" data-comment="Быстрая разминка для бодрого начала дня.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--primary-light); color: var(--primary);">
            <i class="fas fa-sun"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Утренняя зарядка</h3>
          <p class="workout-description">Быстрая разминка для бодрого начала дня.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 15 мин</span>
            <span><i class="fas fa-bullseye"></i> Общая разминка</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Силовая тренировка для всего тела" data-intensity="Высокая" data-duration="45" data-comment="Комплекс упражнений для набора мышечной массы.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--tertiary-light); color: var(--tertiary);">
            <i class="fas fa-weight-hanging"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Силовая тренировка для всего тела</h3>
          <p class="workout-description">Комплекс упражнений для набора мышечной массы.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 45 мин</span>
            <span><i class="fas fa-bullseye"></i> Набор массы</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Кардио-интервалы (ВИИТ)" data-intensity="Высокая" data-duration="30" data-comment="Высокоинтенсивные интервальные тренировки.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--danger-light); color: var(--danger);">
            <i class="fas fa-fire"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Кардио-интервалы (ВИИТ)</h3>
          <p class="workout-description">Высокоинтенсивные интервальные тренировки.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 30 мин</span>
            <span><i class="fas fa-bullseye"></i> Выносливость, жиросжигание</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Вечерняя йога для расслабления" data-intensity="Низкая" data-duration="20" data-comment="Мягкая йога для снятия стресса и улучшения гибкости.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--success-light); color: var(--success);">
            <i class="fas fa-leaf"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Вечерняя йога для расслабления</h3>
          <p class="workout-description">Мягкая йога для снятия стресса и улучшения гибкости.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 20 мин</span>
            <span><i class="fas fa-bullseye"></i> Гибкость, расслабление</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Фитнес-челлендж на 30 дней" data-intensity="Средняя" data-duration="30" data-comment="Комплексный план тренировок на месяц для общего укрепления тела.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--info-light); color: var(--info);">
            <i class="fas fa-calendar-alt"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Фитнес-челлендж на 30 дней</h3>
          <p class="workout-description">Комплексный план тренировок на месяц для общего укрепления тела.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 30 мин</span>
            <span><i class="fas fa-bullseye"></i> Общая физическая подготовка</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Тренировка для пресса" data-intensity="Высокая" data-duration="15" data-comment="Интенсивная тренировка для укрепления мышц кора.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--warning-light); color: var(--warning);">
            <i class="fas fa-fire-alt"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Тренировка для пресса</h3>
          <p class="workout-description">Интенсивная тренировка для укрепления мышц кора.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 15 мин</span>
            <span><i class="fas fa-bullseye"></i> Мышцы кора</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Растяжка после тренировки" data-intensity="Низкая" data-duration="10" data-comment="Комплекс упражнений для восстановления мышц после физической нагрузки.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--primary-light); color: var(--primary);">
            <i class="fas fa-peace"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Растяжка после тренировки</h3>
          <p class="workout-description">Комплекс упражнений для восстановления мышц после физической нагрузки.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 10 мин</span>
            <span><i class="fas fa-bullseye"></i> Восстановление, гибкость</span>
          </div>
        </div>
      </div>
      <div class="workout-card" data-activity="Круговая тренировка" data-intensity="Высокая" data-duration="40" data-comment="Функциональная тренировка для всего тела, направленная на развитие силы и выносливости.">
        <div class="workout-header">
          <div class="workout-icon" style="background-color: var(--tertiary-light); color: var(--tertiary);">
            <i class="fas fa-redo-alt"></i>
          </div>
        </div>
        <div class="workout-content">
          <h3 class="workout-title">Круговая тренировка</h3>
          <p class="workout-description">Функциональная тренировка для всего тела, направленная на развитие силы и выносливости.</p>
          <div class="workout-details">
            <span><i class="fas fa-clock"></i> 40 мин</span>
            <span><i class="fas fa-bullseye"></i> Сила, выносливость</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="filters-section" style="margin-bottom: 24px;">
    <div class="workout-filters" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
      <button class="chip-filter active" data-type="all"><i class="fas fa-list"></i> Все</button>
      <button class="chip-filter" data-type="cardio"><i class="fas fa-running"></i> Кардио</button>
      <button class="chip-filter" data-type="strength"><i class="fas fa-dumbbell"></i> Силовые</button>
      <button class="chip-filter" data-type="yoga"><i class="fas fa-spa"></i> Йога</button>
      <button class="chip-filter" data-type="stretch"><i class="fas fa-child"></i> Растяжка</button>
      <input type="text" id="workout-search" class="search-input" placeholder="Поиск по названию..." style="margin-left:auto; min-width:180px;">
      <button class="btn btn-primary" id="add-workout-btn"><i class="fas fa-plus"></i> Добавить</button>
    </div>
  </div>
  <div id="workouts-list" class="workout-list" style="display: flex; flex-direction: column; gap: 20px;">
    {% if workouts %}
      {% for w in workouts %}
        <div class="workout-history-card" data-type="{{ w.activity|lower }}" style="display:flex;align-items:center;gap:24px;background:var(--card-bg);border-radius:16px;box-shadow:var(--shadow-md);padding:18px 24px;flex-wrap:wrap;">
          <div style="min-width:60px;text-align:center;">
            <div style="font-size:2em;color:var(--primary);font-weight:700;">{{ w.activity[0]|upper }}</div>
            <div style="font-size:0.95em;color:var(--text-muted);margin-top:2px;">{{ w.created_at }}</div>
          </div>
          <div style="flex:1;min-width:180px;">
            <div style="font-size:1.15em;font-weight:600;">{{ w.activity }}</div>
            <div style="font-size:0.98em;color:var(--text-muted);margin-top:2px;">Интенсивность: {{ w.intensity }}</div>
            <div style="font-size:0.98em;color:var(--text-muted);margin-top:2px;">Комментарий: {{ w.comment or '-' }}</div>
          </div>
          <div style="min-width:110px;text-align:center;">
            <div style="font-size:1.1em;"><i class="fas fa-clock"></i> {{ w.duration }} мин</div>
            <div style="font-size:1.1em;"><i class="fas fa-fire"></i> {{ w.calories_burned|round(0) }} ккал</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-outline edit-workout-btn" data-id="{{ w.id }}"><i class="fas fa-edit"></i> Изменить</button>
            <button class="btn btn-outline btn-danger delete-workout-btn" data-id="{{ w.id }}"><i class="fas fa-trash"></i> Удалить</button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div style="color:var(--text-muted);padding:32px;text-align:center;">У вас пока нет завершённых тренировок</div>
    {% endif %}
  </div>
</div>

<!-- Модальное окно для добавления/редактирования тренировки -->
<div id="workout-modal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#fff; border-radius:12px; max-width:400px; width:90vw; padding:32px 24px; position:relative;">
    <button id="close-workout-modal" style="position:absolute; top:12px; right:12px; background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
    <h2 id="workout-modal-title" style="margin-bottom:18px;">Добавить тренировку</h2>
    <form id="workout-form">
      <input type="hidden" name="workout_id" id="workout-id">
      <div class="form-group">
        <label for="workout-activity">Активность</label>
        <input type="text" id="workout-activity" name="activity" class="form-control" required placeholder="Например, Бег">
      </div>
      <div class="form-group">
        <label for="workout-intensity">Интенсивность</label>
        <select id="workout-intensity" name="intensity" class="form-control" required>
          <option value="Обычная">Обычная</option>
          <option value="Высокая">Высокая</option>
          <option value="Низкая">Низкая</option>
        </select>
      </div>
      <div class="form-group">
        <label for="workout-duration">Длительность (мин)</label>
        <input type="number" id="workout-duration" name="duration" class="form-control" min="1" required>
      </div>
      <div class="form-group">
        <label for="workout-comment">Комментарий</label>
        <input type="text" id="workout-comment" name="comment" class="form-control" placeholder="(необязательно)">
      </div>
      <button type="submit" class="btn btn-primary" id="save-workout-btn">Сохранить</button>
    </form>
  </div>
</div>

<!-- Модальное окно для планирования тренировки -->
<div id="schedule-workout-modal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#fff; border-radius:12px; max-width:400px; width:90vw; padding:32px 24px; position:relative;">
    <button id="close-schedule-workout-modal" style="position:absolute; top:12px; right:12px; background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
    <h2 style="margin-bottom:18px;">Запланировать тренировку</h2>
    <form id="schedule-workout-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="activity" id="schedule-activity">
      <div class="form-group">
        <label for="schedule-scheduled-time">Дата и время</label>
        <input type="datetime-local" id="schedule-scheduled-time" name="scheduled_time" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Запланировать</button>
    </form>
  </div>
</div>

<style>
.chip-filter {
  border: none;
  background: #f3f6fa;
  color: #4361ee;
  border-radius: 20px;
  padding: 8px 18px;
  font-size: 1em;
  cursor: pointer;
  transition: background .2s, color .2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.chip-filter.active, .chip-filter:hover {
  background: #4361ee;
  color: #fff;
}
.search-input {
  border: 1.5px solid #e0e6ed;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 1em;
  outline: none;
  transition: border .2s;
}
.search-input:focus {
  border: 1.5px solid #4361ee;
}
@media (max-width: 700px) {
  .workout-history-card {flex-direction:column;align-items:stretch;gap:12px;}
  .workout-history-card > div {min-width:unset !important;}
}
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const workoutSearchInput = document.getElementById('workout-search');
    const workoutCards = document.querySelectorAll('.workout-card[data-activity]');
    const addWorkoutBtn = document.getElementById('add-workout-btn');
    const workoutModal = document.getElementById('workout-modal');
    const closeWorkoutModalBtn = document.getElementById('close-workout-modal');
    const workoutForm = document.getElementById('workout-form');
    const workoutModalTitle = document.getElementById('workout-modal-title');
    const workoutIdInput = document.getElementById('workout-id');
    const workoutActivityInput = document.getElementById('workout-activity');
    const workoutIntensityInput = document.getElementById('workout-intensity');
    const workoutDurationInput = document.getElementById('workout-duration');
    const workoutCommentInput = document.getElementById('workout-comment');

    // Schedule Workout Modal elements
    const scheduleWorkoutModal = document.getElementById('schedule-workout-modal');
    const closeScheduleWorkoutModalBtn = document.getElementById('close-schedule-workout-modal');
    const scheduleWorkoutForm = document.getElementById('schedule-workout-form');
    const scheduleActivityInput = document.getElementById('schedule-activity');
    const scheduleScheduledTimeInput = document.getElementById('schedule-scheduled-time');
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;


    // Filter functionality
    document.querySelectorAll('.chip-filter').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.chip-filter').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        filterWorkouts();
      });
    });

    workoutSearchInput.addEventListener('keyup', filterWorkouts);

    function filterWorkouts() {
      const activeFilter = document.querySelector('.chip-filter.active').dataset.type;
      const searchTerm = workoutSearchInput.value.toLowerCase();

      document.querySelectorAll('.workout-history-card').forEach(card => {
        const activity = card.dataset.type.toLowerCase();
        const title = card.querySelector('.workout-title').textContent.toLowerCase();
        
        const matchesFilter = (activeFilter === 'all' || activity.includes(activeFilter));
        const matchesSearch = title.includes(searchTerm);

        if (matchesFilter && matchesSearch) {
          card.style.display = 'flex';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // Add/Edit Workout Modal functionality
    addWorkoutBtn.addEventListener('click', function() {
      workoutModalTitle.textContent = 'Добавить тренировку';
      workoutForm.reset();
      workoutIdInput.value = '';
      workoutModal.style.display = 'flex';
    });

    closeWorkoutModalBtn.addEventListener('click', function() {
      workoutModal.style.display = 'none';
    });

    // Open Schedule Workout Modal when a workout card is clicked
    workoutCards.forEach(card => {
      card.addEventListener('click', function() {
        const activity = this.dataset.activity;
        scheduleActivityInput.value = activity;
        scheduleScheduledTimeInput.value = ''; // Clear previous value
        scheduleWorkoutModal.style.display = 'flex';
      });
    });

    closeScheduleWorkoutModalBtn.addEventListener('click', function() {
      scheduleWorkoutModal.style.display = 'none';
    });

    // Handle Schedule Workout Form Submission
    scheduleWorkoutForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch('/dashboard/add-schedule', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams(formData)
        });

        if (response.ok) {
          const result = await response.json(); // Expect JSON response for success/error
          if (result.status === 'success') {
            alert(result.message);
            scheduleWorkoutModal.style.display = 'none';
            // Optionally, refresh dashboard's upcoming workouts list if needed
            window.location.href = '/dashboard'; // Redirect to dashboard to see scheduled workout
          } else {
            alert('Ошибка: ' + result.message);
          }
        } else {
          const errorText = await response.text();
          console.error('Backend error scheduling workout:', errorText);
          alert('Произошла ошибка при планировании тренировки. Проверьте консоль для деталей.');
        }
      } catch (error) {
        console.error('Network error scheduling workout:', error);
        alert('Произошла ошибка сети при планировании тренировки.');
      }
    });

    // Edit/Delete Workout History functionality
    // This part should be updated if these buttons are moved or their functionality changes
    document.querySelectorAll('.edit-workout-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const workoutId = this.dataset.id;
        try {
          const response = await fetch(`/workouts/${workoutId}`);
          const data = await response.json();
          if (response.ok) {
            workoutModalTitle.textContent = 'Редактировать тренировку';
            workoutIdInput.value = data.id;
            workoutActivityInput.value = data.activity;
            workoutIntensityInput.value = data.intensity;
            workoutDurationInput.value = data.duration;
            workoutCommentInput.value = data.comment || '';
            workoutModal.style.display = 'flex';
          } else {
            alert('Ошибка загрузки данных тренировки: ' + data.error);
          }
        } catch (error) {
          console.error('Error fetching workout data:', error);
          alert('Произошла ошибка при загрузке данных тренировки.');
        }
      });
    });

    document.querySelectorAll('.delete-workout-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const workoutId = this.dataset.id;
        if (confirm('Вы уверены, что хотите удалить эту тренировку?')) {
          try {
            const response = await fetch(`/workouts/delete/${workoutId}`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken
              },
              body: new URLSearchParams({'csrf_token': csrfToken})
            });
            const result = await response.json();
            if (result.success) {
              alert('Тренировка успешно удалена!');
              location.reload(); // Reload page to reflect changes
            } else {
              alert('Ошибка при удалении: ' + result.message);
            }
          } catch (error) {
            console.error('Error deleting workout:', error);
            alert('Произошла ошибка сети или сервера при удалении тренировки.');
          }
        }
      });
    });

    workoutForm.addEventListener('submit', async function(event) {
      event.preventDefault();
      const workoutId = workoutIdInput.value;
      const formData = new FormData(this);
      const url = workoutId ? `/workouts/edit/${workoutId}` : '/workouts/add';
      const method = workoutId ? 'POST' : 'POST'; // Use POST for both add and edit

      try {
        const response = await fetch(url, {
          method: method,
          headers: {
            'X-CSRFToken': csrfToken
          },
          body: new URLSearchParams(formData)
        });

        const result = await response.json();
        if (result.success) {
          alert(result.message);
          workoutModal.style.display = 'none';
          location.reload(); // Reload page to reflect changes
        } else {
          alert('Ошибка: ' + result.message);
        }
      } catch (error) {
        console.error('Error submitting workout form:', error);
        alert('Произошла ошибка сети или сервера при сохранении тренировки.');
      }
    });

  });
</script>
{% endblock %}
